<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>彩色版服藥記錄表單</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <style>
        :root {
            --abilify-color: #4f46e5;
            --abilify-light: #eef2ff;
            --ritalin-color: #0ea5e9;
            --ritalin-light: #e0f2fe;
            --highlight-color: #8b5cf6;
        }
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header-gradient {
            background: linear-gradient(135deg, var(--abilify-color), var(--ritalin-color));
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 15px;
            margin-bottom: 0;
        }
        .form-panel {
            border-left: 5px solid var(--highlight-color);
        }
        .abilify-bg {
            background-color: var(--abilify-light);
            border-left: 4px solid var(--abilify-color);
        }
        .ritalin-bg {
            background-color: var(--ritalin-light);
            border-left: 4px solid var(--ritalin-color);
        }
        .btn-abilify {
            background-color: var(--abilify-color);
            color: white;
        }
        .btn-abilify:hover {
            background-color: #4338ca;
        }
        .btn-ritalin {
            background-color: var(--ritalin-color);
            color: white;
        }
        .btn-ritalin:hover {
            background-color: #0284c7;
        }
        .record-item {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .record-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container p-4">
        <div class="bg-white rounded-lg shadow-lg my-6">
            <h1 class="text-2xl font-bold text-center header-gradient">線上服藥記錄表單</h1>
            
            <!-- 輸入區域 -->
            <div class="p-6 no-print">
                <div class="form-panel bg-gray-50 p-5 rounded-lg mb-8">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">藥物選擇</label>
                        <select id="medicationId" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-300 focus:border-purple-300">
                            <option value="abilify">ABILIFY TAB 5 MG (ARIPIPRAZOLE) (大塚安立復錠5毫克)</option>
                            <option value="ritalin">RITALIN TAB 10 MG (METHYLPHENIDATE HCL) (利他能錠10毫克)</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                            <input type="date" id="date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-300 focus:border-purple-300">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">時間</label>
                            <input type="time" id="time" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-300 focus:border-purple-300">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="taken" class="h-5 w-5 text-purple-600 rounded focus:ring-purple-500">
                            <label for="taken" class="ml-2 block text-sm font-medium text-gray-700">
                                已服藥
                            </label>
                        </div>
                    </div>

                    <div id="medicationInfo" class="mb-4 p-4 rounded-lg">
                        <!-- 藥物資訊將由JavaScript動態填充 -->
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                        <textarea id="notes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-300 focus:border-purple-300" placeholder="補充說明（如：實際服用劑量、服藥感受等）"></textarea>
                    </div>
                    
                    <button id="addRecord" class="w-full bg-highlight-color hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200" style="background-color: var(--highlight-color);">
                        添加記錄
                    </button>
                    
                    <div class="flex justify-between mt-4">
                        <button id="exportRecords" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                            匯出記錄
                        </button>
                        <button id="printRecords" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                            列印記錄
                        </button>
                    </div>
                </div>
                
                <!-- 記錄列表 -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">歷史記錄</h2>
                    <div id="recordsList" class="space-y-4">
                        <!-- 記錄將由JavaScript動態填充 -->
                    </div>
                </div>

                <!-- 注意事項區 -->
                <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="text-lg font-medium text-yellow-800 mb-2">藥物注意事項</h3>
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-800">ABILIFY (大塚安立復錠)</h4>
                        <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
                            <li>可空腹或隨餐(飯後立即)服用</li>
                            <li>用藥期間開車或操作機械請小心</li>
                            <li>用藥期間請勿飲酒</li>
                            <li>避免劇烈運動或曝露於過熱環境</li>
                            <li>按照醫囑確實服藥，不可自行停用</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800">RITALIN (利他能錠)</h4>
                        <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
                            <li>於飯前30至45分鐘服用</li>
                            <li>請於晚上六點前服用</li>
                            <li>請遵醫囑服用</li>
                            <li>不可擅自停藥</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 藥物資料
        const medications = {
            abilify: {
                id: "abilify",
                name: "ABILIFY TAB 5 MG (ARIPIPRAZOLE)",
                chineseName: "大塚安立復錠5毫克",
                dosage: "睡前使用，每次0.5粒",
                indications: "精神疾患、亞斯伯格症",
                sideEffects: "體重增加、想睡或頭痛等情形",
                precautions: "可空腹或隨餐(飯後立即)服用、用藥期間開車或操作機械請小心、用藥期間請勿飲酒、避免劇烈運動或曝露於過熱環境、按照醫囑確實服藥",
                colorClass: "abilify-bg"
            },
            ritalin: {
                id: "ritalin",
                name: "RITALIN TAB 10 MG (METHYLPHENIDATE HCL)",
                chineseName: "利他能錠10毫克",
                dosage: "每日一次早上7時使用，每次1粒",
                indications: "過動兒症候群、發作性嗜睡症",
                sideEffects: "食慾降低、腹痛、體重減輕、視力模糊",
                precautions: "於飯前30至45分鐘服用、請於晚上六點前服用、請遵醫囑服用",
                colorClass: "ritalin-bg"
            }
        };

        // DOM元素
        const elements = {
            medicationId: document.getElementById('medicationId'),
            date: document.getElementById('date'),
            time: document.getElementById('time'),
            taken: document.getElementById('taken'),
            notes: document.getElementById('notes'),
            addRecord: document.getElementById('addRecord'),
            exportRecords: document.getElementById('exportRecords'),
            printRecords: document.getElementById('printRecords'),
            recordsList: document.getElementById('recordsList'),
            medicationInfo: document.getElementById('medicationInfo')
        };

        // 初始化日期和時間
        function initializeDateAndTime() {
            const now = new Date();
            elements.date.value = now.toISOString().slice(0, 10);
            elements.time.value = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // 數據庫操作 - 使用cookie而非localStorage
        const DB = {
            // 保存記錄至cookie
            saveRecords: function(records) {
                try {
                    const data = JSON.stringify(records);
                    // 設置cookie，一年有效期
                    const expiryDate = new Date();
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                    document.cookie = `medicationRecords=${encodeURIComponent(data)};expires=${expiryDate.toUTCString()};path=/;SameSite=Lax`;
                    return true;
                } catch (e) {
                    console.error('保存記錄失敗:', e);
                    return false;
                }
            },
            
            // 從cookie中獲取記錄
            loadRecords: function() {
                try {
                    const cookieValue = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('medicationRecords='));
                    
                    if (cookieValue) {
                        const data = decodeURIComponent(cookieValue.split('=')[1]);
                        return JSON.parse(data);
                    }
                    return [];
                } catch (e) {
                    console.error('讀取記錄失敗:', e);
                    return [];
                }
            }
        };

        // 載入記錄
        function loadRecords() {
            return DB.loadRecords();
        }

        // 保存記錄
        function saveRecords(records) {
            return DB.saveRecords(records);
        }

        // 更新藥物資訊顯示
        function updateMedicationInfo() {
            const selectedMedication = medications[elements.medicationId.value];
            elements.medicationInfo.className = `mb-4 p-4 rounded-lg ${selectedMedication.colorClass}`;
            elements.medicationInfo.innerHTML = `
                <h3 class="font-medium mb-1 text-gray-800">用藥資訊</h3>
                <p class="text-sm text-gray-700"><strong>劑量:</strong> ${selectedMedication.dosage}</p>
                <p class="text-sm text-gray-700"><strong>適應症:</strong> ${selectedMedication.indications}</p>
                <p class="text-sm text-gray-700"><strong>可能副作用:</strong> ${selectedMedication.sideEffects}</p>
            `;
        }

        // 渲染記錄列表
        function renderRecords() {
            const records = loadRecords();
            
            if (!records || records.length === 0) {
                elements.recordsList.innerHTML = '<p class="text-gray-500 text-center p-4">尚無服藥記錄</p>';
                return;
            }
            
            elements.recordsList.innerHTML = records.map(record => `
                <div class="record-item p-4 border ${medications[record.medicationId] ? medications[record.medicationId].colorClass : 'bg-gray-50'}">
                    <div class="flex justify-between items-start">
                        <div class="w-full">
                            <div class="flex flex-wrap items-center justify-between">
                                <div>
                                    <span class="font-medium">${record.date} ${record.time}</span>
                                    <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        record.taken ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }">
                                        ${record.taken ? '已服藥' : '未服藥'}
                                    </span>
                                </div>
                                <button class="delete-record text-red-500 hover:text-red-700 no-print" data-id="${record.id}">
                                    刪除
                                </button>
                            </div>
                            
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-900">${record.medicationName}</p>
                                <p class="text-xs text-gray-600">${record.medicationChineseName}</p>
                            </div>
                            
                            ${record.notes ? `
                                <div class="mt-2 p-2 bg-white bg-opacity-70 rounded border border-gray-200">
                                    <p class="text-sm text-gray-600"><strong>備註:</strong> ${record.notes}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // 添加刪除按鈕的事件監聽器
            document.querySelectorAll('.delete-record').forEach(button => {
                button.addEventListener('click', function() {
                    deleteRecord(this.dataset.id);
                });
            });
        }

        // 添加記錄
        function addRecord() {
            const records = loadRecords() || [];
            const selectedMedication = medications[elements.medicationId.value];
            
            const newRecord = {
                id: Date.now().toString(),
                date: elements.date.value,
                time: elements.time.value,
                taken: elements.taken.checked,
                notes: elements.notes.value,
                medicationId: elements.medicationId.value,
                medicationName: selectedMedication.name,
                medicationChineseName: selectedMedication.chineseName
            };
            
            records.unshift(newRecord); // 添加到記錄的開頭
            const success = saveRecords(records);
            
            if (success) {
                // 重置表單
                elements.taken.checked = false;
                elements.notes.value = '';
                initializeDateAndTime();
                renderRecords();
            } else {
                // 如果保存失敗，提示用戶
                alert('記錄保存失敗。可能是因為瀏覽器限制或隱私設置。請嘗試下載此頁面在本地運行。');
            }
        }

        // 刪除記錄
        function deleteRecord(id) {
            if (confirm('確定要刪除這條記錄嗎？')) {
                const records = loadRecords();
                if (!records || records.length === 0) return;
                
                const updatedRecords = records.filter(record => record.id !== id);
                saveRecords(updatedRecords);
                renderRecords();
            }
        }

        // 匯出記錄
        function exportRecords() {
            const records = loadRecords();
            if (!records || records.length === 0) {
                alert('沒有記錄可以匯出');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "日期,時間,藥物名稱,中文名稱,是否服藥,備註\n"
                + records.map(record => {
                    return `${record.date},${record.time},${record.medicationName},${record.medicationChineseName},${record.taken ? '是' : '否'},"${record.notes}"`;
                }).join("\n");
            
            try {
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `服藥記錄_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                console.error('匯出失敗:', e);
                alert('匯出記錄失敗。請嘗試手動複製數據。');
            }
        }

        // 列印記錄
        function printRecords() {
            window.print();
        }

        // 初始化
        function initialize() {
            try {
                initializeDateAndTime();
                updateMedicationInfo();
                renderRecords();
                
                // 事件監聽器
                elements.medicationId.addEventListener('change', updateMedicationInfo);
                elements.addRecord.addEventListener('click', addRecord);
                elements.exportRecords.addEventListener('click', exportRecords);
                elements.printRecords.addEventListener('click', printRecords);
                
                // 添加離線儲存提示
                const message = document.createElement('div');
                message.className = 'text-center text-sm text-gray-500 mt-6';
                message.innerHTML = '此應用使用Cookie儲存數據。若在不同瀏覽器或清除Cookie後，記錄將丟失。建議定期匯出備份。';
                document.querySelector('.container').appendChild(message);
            } catch (e) {
                console.error('初始化失敗:', e);
                alert('初始化應用失敗。請嘗試刷新頁面或在其他瀏覽器中打開。');
            }
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>